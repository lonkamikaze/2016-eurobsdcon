\documentclass[aspectratio=169]{beamer}
\beamertemplatenavigationsymbolsempty

\usecolortheme{beaver}

\usepackage{hyperref}              % Support clickable references

\usepackage{fontspec}              % Support non-latin characters
\setmonofont{Source Code Pro}%     % Select Source Code Pro for listings
            [Scale=MatchLowercase, % Adjust glyph size
             BoldFont={* Semibold}]% The Bold face is too bold

\usepackage{listings}              % Code blocks
\lstset{language={[ISO]C++},       % Default programming language
        breaklines=true,           % Break long lines in listings
        showstringspaces=false,    % Do not use visible spaces in strings
        morekeywords={constexpr,   % C++11 keywords
        decltype,static_assert},
        commentstyle=\itshape\color{red!50!black},
        emphstyle=\bfseries\color{red!50!black},
        keywordstyle=\bfseries\color{green!50!black},
        stringstyle=\color{blue!50!green!50!black},
        basicstyle=\ttfamily\footnotesize, % Use a small monospace font
        tabsize=4}                 % Not enough space for propper tabs

\newcommand{\PDPP}{powerd$^{_{_{++}}}$}

\usepackage{tikz}                  % TikZ drawings
\usepackage{pgfplots}
\usepackage{pgfplotstable}
\pgfplotsset{width=13.5cm,height=7.5cm}
\usepgfplotslibrary{external}
\tikzexternalize
\input{../drawings/style.tex}

\usepackage{microtype}             % Enable black magic

\title{Proposing a Replacement for FreeBSD's powerd}
\subtitle{Or, how I tamed the fan of my notebook}

\author[D. Fandrey]{Dominic Fandrey}
\date[EuroBSDcon 2016]{EuroBSDcon 2016, September 2016}
\logo{\includegraphics[width=1.5cm]{logo}}

\begin{document}

\begin{frame}[plain]
\titlepage
\end{frame}

\begin{frame}{kamikaze a.k.a. Dominic Fandrey}
\begin{itemize}
\item \href{mailto:kami@freebsd.org}{Dominic Fandrey <kami@freebsd.org>}
\item M.Sc. (Computer Science)
\item Located in Europe/Karlsruhe
\end{itemize}
\end{frame}

\begin{frame}{Contents}
\tableofcontents
\end{frame}

\section{A long long time ago (February)}

\begin{frame}{A long long time ago (February)}
\end{frame}

\begin{frame}{browser/email load according to \emph{top}}
\begin{tikzpicture}
\begin{axis}[axis load]
\addplot+[load] table[x={time[s]},y=cpu.0.load] {../data/browser-email-80-0-80.csv};
\addplot+[load] table[x={time[s]},y=cpu.1.load] {../data/browser-email-80-0-80.csv};
\addplot+[load] table[x={time[s]},y=cpu.2.load] {../data/browser-email-80-0-80.csv};
\addplot+[load] table[x={time[s]},y=cpu.3.load] {../data/browser-email-80-0-80.csv};
\legend{cpu.0,cpu.1,cpu.2,cpu.3}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{browser/email clock frequency running \emph{powerd}}
\begin{tikzpicture}
\begin{axis}[axis freq]
\addplot+[freq] table[x={time[s]},y={max(freqs)[MHz]}] {../data/browser-email-powerd-hadp.csv};
\legend{dev.cpu.0.freq}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{browser/email load according to \emph{powerd}}
\begin{tikzpicture}
\begin{axis}[axis load]
\addplot+[load] table[x={time[s]},y=sum(loads)] {../data/browser-email-10-0-10.csv};
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{browser/email clock frequency running \emph{powerd adaptive}}
\begin{tikzpicture}
\begin{axis}[axis freq]
\addplot+[freq] table[x={time[s]},y={max(freqs)[MHz]}] {../data/browser-email-powerd-adp.csv};
\legend{dev.cpu.0.freq}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{browser/email clock frequency \emph{expectation}}
\begin{tikzpicture}
\begin{axis}[axis freq]
\addplot+[freq] table[x={time[s]},y={max(freqs)[MHz]}] {../data/browser-email-powerd++-hadp.csv};
\legend{dev.cpu.0.freq}
\end{axis}
\end{tikzpicture}
\end{frame}

\section{Where load stats come from}

\begin{frame}{Where load stats come from}
\end{frame}

\section{Sampling vs. Filtering}

\begin{frame}{Sampling vs. Filtering}
\end{frame}

\begin{frame}{load \emph{25 ms} sampling}
\begin{tikzpicture}
\begin{axis}[axis load]
\addplot+[load] table[x={time[s]},y=cpu.0.recload] {../data/yt-powerd-adp.csv};
\addplot+[load] table[x={time[s]},y=cpu.1.recload] {../data/yt-powerd-adp.csv};
\addplot+[load] table[x={time[s]},y=cpu.2.recload] {../data/yt-powerd-adp.csv};
\addplot+[load] table[x={time[s]},y=cpu.3.recload] {../data/yt-powerd-adp.csv};
\legend{cpu.0,cpu.1,cpu.2,cpu.3}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{load \emph{25 ms} sampling}
\begin{tikzpicture}
\begin{axis}[axis load]
\addplot+[load] table[x={time[s]},y=cpu.0.recload] {../data/yt-powerd-adp.csv};
\legend{cpu.0}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{load \emph{25 ms} sampling, \emph{2 s} filter}
\begin{tikzpicture}
\begin{axis}[axis load]
\addplot+[load,no markers] table[x={time[s]},y=cpu.0.recload] {../data/yt-40-40-1.csv};
\legend{cpu.0}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{load \emph{25 ms} sampling, \emph{2 s} filter}
\begin{tikzpicture}
\begin{axis}[axis load]
\addplot+[load,no markers] table[x={time[s]},y=cpu.0.recload] {../data/yt-40-40-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.0.recload] {../data/yt-80-0-1.csv};
\legend{cpu.0 symmetric,cpu.0 past}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{load sampling vs. filtering comparison}
\begin{tikzpicture}
\begin{axis}[axis load]
\addplot+[load,no markers] table[x={time[s]},y=cpu.0.recload] {../data/yt-40-40-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.0.recload] {../data/yt-80-0-1.csv};
\addplot+[load] table[x={time[s]},y=cpu.0.recload] {../data/yt-10-0-10.csv};
\legend{cpu.0 symmetric,cpu.0 past,$250 ms$ sample}
\end{axis}
\end{tikzpicture}
\end{frame}

\section{Load Aggregation}

\begin{frame}{Load Aggregation}
\end{frame}

\begin{frame}{challenge, find the right frequency for \emph{all} cores}
\begin{tikzpicture}
\begin{axis}[axis load]
\addplot+[load,no markers] table[x={time[s]},y=cpu.0.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.1.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.2.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.3.recload] {../data/xetex-80-0-1.csv};
\legend{cpu.0,cpu.1,cpu.2,cpu.3}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}[fragile]{powerd.c}
\begin{lstlisting}
/*
 * This function returns summary load of all CPUs.  It was made so
 * intentionally to not reduce performance in scenarios when several
 * threads are processing requests as a pipeline -- running one at
 * a time on different CPUs and waiting for each other.
 */
static int
read_usage_times(int *load)
\end{lstlisting}
\end{frame}

\begin{frame}{using the sum}
\begin{tikzpicture}
\begin{axis}[axis load,ymax=2.5]
\draw (axis cs:0,1) -- (axis cs:30,1) {};
\addplot+[load,no markers] table[x={time[s]},y=cpu.0.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.1.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.2.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.3.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,thick,no markers] table[x={time[s]},y=sum(recloads)] {../data/xetex-80-0-1.csv};
\legend{cpu.0,cpu.1,cpu.2,cpu.3,sum(loads)}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{powerd flavoured}
\begin{tikzpicture}
\begin{axis}[axis load,ymax=2.5]
\draw (axis cs:0,1) -- (axis cs:30,1) {};
\addplot+[load] table[x={time[s]},y=cpu.0.recload] {../data/xetex-10-0-10.csv};
\addplot+[load] table[x={time[s]},y=cpu.1.recload] {../data/xetex-10-0-10.csv};
\addplot+[load] table[x={time[s]},y=cpu.2.recload] {../data/xetex-10-0-10.csv};
\addplot+[load] table[x={time[s]},y=cpu.3.recload] {../data/xetex-10-0-10.csv};
\addplot+[load,thick] table[x={time[s]},y=sum(recloads)] {../data/xetex-10-0-10.csv};
\legend{cpu.0,cpu.1,cpu.2,cpu.3,sum(loads)}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{proposal}
\begin{tikzpicture}
\begin{axis}[axis load]
\addplot+[load,no markers] table[x={time[s]},y=cpu.0.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.1.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.2.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.3.recload] {../data/xetex-80-0-1.csv};
\legend{cpu.0,cpu.1,cpu.2,cpu.3,max(loads)}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{use the max}
\begin{tikzpicture}
\begin{axis}[axis load]
\addplot+[load,no markers] table[x={time[s]},y=cpu.0.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.1.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.2.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,no markers] table[x={time[s]},y=cpu.3.recload] {../data/xetex-80-0-1.csv};
\addplot+[load,thick,no markers] table[x={time[s]},y=max(recloads)] {../data/xetex-80-0-1.csv};
\legend{cpu.0,cpu.1,cpu.2,cpu.3,max(loads)}
\end{axis}
\end{tikzpicture}
\end{frame}

\begin{frame}{Definitions}
\begin{itemize}
\item Load: \begin{itemize}
      \item<2-> The fraction of CPU cycles not spent idle
      \end{itemize}
\item<3-> P-State: \begin{itemize}
      \item<4-> Performance State, also frequently called stepping
      \item<5-> A CPU mode of operation with a specific clock frequency
                and core voltage
      \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}{CPU p-state control}
\centering
\begin{tikzpicture}
\input{../drawings/powerd++-demo-load}
\onslide<2->{\input{../drawings/powerd++-demo-freq}}
\end{tikzpicture}
\end{frame}

\section{Why?}

\begin{frame}{Why control p-state?}
\begin{columns}[onlytextwidth]
\begin{column}{0.4\textwidth}
\begin{itemize}
\item<1-> Fan noise
\item<2-> Battery/Energy conservation
\item<3-> Hardware lifetime
\end{itemize}
\end{column}
\begin{column}{0.6\textwidth}
\begin{tikzpicture}[scale=.6]
\input{../drawings/powerd++-demo-load}
\input{../drawings/powerd++-demo-freq}
\end{tikzpicture}
\end{column}
\end{columns}
\end{frame}

\begin{frame}{Why replace powerd?}
\centering
\begin{tikzpicture}
\input{../drawings/powerd-demo-load}
\onslide<2->{\input{../drawings/powerd-demo-freq}}
\end{tikzpicture}
\end{frame}

\begin{frame}{Why replace powerd?}
\begin{columns}[onlytextwidth]
\begin{column}{0.4\textwidth}
\begin{itemize}
\item<1-> Broken load estimation
\item<2-> Aggressive speeding
\item<3-> Reluctant braking
\item<4-> Excessive fan noise
\end{itemize}
\end{column}
\begin{column}{0.6\textwidth}
\begin{tikzpicture}[scale=.6]
\input{../drawings/powerd-demo-load}
\input{../drawings/powerd-demo-freq}
\end{tikzpicture}
\end{column}
\end{columns}
\end{frame}

\section{Challenges!}

\begin{frame}{Measuring loads}
\centering
\begin{tikzpicture}
\input{../drawings/per-cpu-loads}
\end{tikzpicture}
\end{frame}

\begin{frame}{Measuring loads}
\begin{columns}[onlytextwidth]
\begin{column}{0.4\textwidth}
\begin{itemize}
\item<1-> Load is noisy
\item<2-> Load shifts
\item<3-> Load saturates
\end{itemize}
\end{column}
\begin{column}{0.6\textwidth}
\begin{tikzpicture}[scale=.6]
\input{../drawings/per-cpu-loads}
\end{tikzpicture}
\end{column}
\end{columns}
\end{frame}

\begin{frame}{Control algorithm}
\begin{columns}[onlytextwidth]
\begin{column}{0.6\textwidth}
\begin{itemize}
\item Contradicting goals: \begin{itemize}
      \item<2-> System should be responsive
      \item<3-> System should be energy efficient
      \end{itemize}
\item<4-> P-States: \begin{itemize}
      \item<5-> P-States lie
      \item<6-> Extremely low nonsense p-states
      \item<7-> P-State switching has a cost
      \end{itemize}
\end{itemize}
\end{column}
\begin{column}{0.4\textwidth}
\begin{itemize}
\item<8-> Conclusions: \begin{itemize}
      \item<9-> Make the right compromises
      \item<10-> Make it tunable
      \item<11-> Set sane defaults
      \end{itemize}
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\section{How?}

\begin{frame}{Summary}
\begin{columns}[onlytextwidth]
\begin{column}{0.45\textwidth}
\centering
\PDPP
\begin{itemize}
\item<2-> Any granularity p-state changes
\item<4-> Maximum load
\item<6-> Aim for a load target
\item<8-> Filter load to ignore short spikes
\item<10-> Explicit CLA syntax like \lstinline{--max 1.2ghz}
\end{itemize}
\end{column}
\begin{column}{0.1\textwidth}
\centering
versus
\end{column}
\begin{column}{0.45\textwidth}
\centering
powerd
\begin{itemize}
\item<3-> Global p-state changes only
\item<5-> Sum of loads
\item<7-> Hysteresis
\item<9-> Aggressively tuned for responsiveness
\item<11-> Hard coded units \lstinline{-M 1200}
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\begin{frame}{Control algorithm (powerd)}
\centering
\includegraphics[height=6.5cm]{arch_powerd}
\end{frame}

\begin{frame}{Control algorithm (\PDPP)}
\centering
\includegraphics[height=6.5cm]{arch_powerd++}
\end{frame}

\begin{frame}{Dealing with signal noise}
\begin{tikzpicture}
\onslide<1>{\input{../drawings/per-cpu-loads}}
\onslide<2>{\input{../drawings/per-cpu-loads-powerd}}
\onslide<3>{\input{../drawings/per-cpu-loads-powerd-unlimited}}
\onslide<4>{\input{../drawings/per-cpu-loads-filtered}}
\onslide<5>{\input{../drawings/per-cpu-loads-powerd++}}
\end{tikzpicture}
\end{frame}

\section{Conclusions!}

\begin{frame}{Solved problems}
\begin{columns}[onlytextwidth]
\begin{column}{0.5\textwidth}
\begin{itemize}
\item<1-> Load signal noise
\item<3-> Low multi core loads
\end{itemize}
\end{column}
\begin{column}{0.5\textwidth}
\begin{itemize}
\item<2-> Lower sample rate, gliding average
\item<4-> Without breaking single core loads
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\begin{frame}{Unsolved problems}
\begin{columns}[onlytextwidth]
\begin{column}{0.5\textwidth}
\begin{itemize}
\item<1-> High frequency core hopping
\item<3-> P-States that lie reduce accuracy
\item<5-> \lstinline{kern_clock.c} only supports global frequency changes
\end{itemize}
\end{column}
\begin{column}{0.5\textwidth}
\begin{itemize}
\item<2-> This is rare
\item<4-> Ignoring this works well enough
\item<6-> This is fixable, but may break scheduling
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\begin{frame}
\centering
\textbackslash(-)/\\
Praise the sun!\\
\vspace{1cm}
\url{https://github.com/lonkamikaze/powerdxx}
\end{frame}

\end{document}
