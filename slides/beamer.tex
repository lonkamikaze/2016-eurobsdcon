\documentclass[aspectratio=169]{beamer}
\beamertemplatenavigationsymbolsempty

\usecolortheme{beaver}

\usepackage{hyperref}              % Support clickable references

\usepackage{fontspec}              % Support non-latin characters
\setmonofont{Source Code Pro}%     % Select Source Code Pro for listings
            [Scale=MatchLowercase, % Adjust glyph size
             BoldFont={* Semibold}]% The Bold face is too bold

\usepackage{listings}              % Code blocks
\lstset{basicstyle=\ttfamily\small}% Use a small monospace font

\newcommand{\PDPP}{powerd$^{_{_{++}}}$}

\usepackage{tikz}                  % TikZ drawings
\usepackage{pgfplots}
\usepackage{pgfplotstable}
\pgfplotsset{width=13.5cm,height=7.5cm}
\usepgfplotslibrary{external}
\tikzexternalize
\input{../drawings/style.tex}

\usepackage{microtype}             % Enable black magic

\title{Proposing a Replacement for FreeBSD's powerd}
\subtitle{Or, how I tamed the fan of my notebook}

\author[D. Fandrey]{Dominic Fandrey}
\date[EuroBSDcon 2016]{EuroBSDcon 2016, September 2016}
\logo{\includegraphics[width=1.5cm]{logo}}

\begin{document}

\begin{frame}[plain]
\titlepage
\end{frame}

\begin{frame}{kamikaze a.k.a. Dominic Fandrey}
\begin{itemize}
\item \href{mailto:kami@freebsd.org}{Dominic Fandrey <kami@freebsd.org>}
\item M.Sc. (Computer Science)
\item Located in Europe/Karlsruhe
\end{itemize}
\end{frame}

\begin{frame}{Contents}
\tableofcontents
\end{frame}

\section{Who?}

\begin{frame}{kamikaze a.k.a. Dominic Fandrey}
\begin{itemize}
\item<1-> \href{mailto:kami@freebsd.org}{Dominic Fandrey <kami@freebsd.org>}
\item<1-> M.Sc. (Computer Science)
\item<2-> Located in Europe/Karlsruhe
\item<3-> Working as a researcher at an undisclosed polytechnic university
\item<3-> \begin{tikzpicture}[node distance=3cm]
\node (mugshot) {\includegraphics[height=3.0cm]{../images/mugshot}};
\onslide<4->{
\node (hair)[right of=mugshot] {\includegraphics[height=3.0cm]{../images/interests_hair}};}
\onslide<5->{
\node (uni)[right of=hair] {\includegraphics[height=3.0cm]{../images/interests_uni}};}
\onslide<6->{
\node (freebsd)[right of=uni] {\includegraphics[height=3.0cm]{freebsd-logo}};}
\end{tikzpicture}
\end{itemize}
\end{frame}

\section{What?}

\begin{frame}{Definitions}
\begin{itemize}
\item Load: \begin{itemize}
      \item<2-> The fraction of CPU cycles not spent idle
      \end{itemize}
\item<3-> P-State: \begin{itemize}
      \item<4-> Performance State, also frequently called stepping
      \item<5-> A CPU mode of operation with a specific clock frequency
                and core voltage
      \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}{CPU p-state control}
\centering
\begin{tikzpicture}
\input{../drawings/powerd++-demo-load}
\onslide<2->{\input{../drawings/powerd++-demo-freq}}
\end{tikzpicture}
\end{frame}

\section{Why?}

\begin{frame}{Why control p-state?}
\begin{columns}[onlytextwidth]
\begin{column}{0.4\textwidth}
\begin{itemize}
\item<1-> Fan noise
\item<2-> Battery/Energy conservation
\item<3-> Hardware lifetime
\end{itemize}
\end{column}
\begin{column}{0.6\textwidth}
\begin{tikzpicture}[scale=.6]
\input{../drawings/powerd++-demo-load}
\input{../drawings/powerd++-demo-freq}
\end{tikzpicture}
\end{column}
\end{columns}
\end{frame}

\begin{frame}{Why replace powerd?}
\centering
\begin{tikzpicture}
\input{../drawings/powerd-demo-load}
\onslide<2->{\input{../drawings/powerd-demo-freq}}
\end{tikzpicture}
\end{frame}

\begin{frame}{Why replace powerd?}
\begin{columns}[onlytextwidth]
\begin{column}{0.4\textwidth}
\begin{itemize}
\item<1-> Broken load estimation
\item<2-> Aggressive speeding
\item<3-> Reluctant braking
\item<4-> Excessive fan noise
\end{itemize}
\end{column}
\begin{column}{0.6\textwidth}
\begin{tikzpicture}[scale=.6]
\input{../drawings/powerd-demo-load}
\input{../drawings/powerd-demo-freq}
\end{tikzpicture}
\end{column}
\end{columns}
\end{frame}

\section{Challenges!}

\begin{frame}{Measuring loads}
\centering
\begin{tikzpicture}
\input{../drawings/per-cpu-loads}
\end{tikzpicture}
\end{frame}

\begin{frame}{Measuring loads}
\begin{columns}[onlytextwidth]
\begin{column}{0.4\textwidth}
\begin{itemize}
\item<1-> Load is noisy
\item<2-> Load shifts
\item<3-> Load saturates
\end{itemize}
\end{column}
\begin{column}{0.6\textwidth}
\begin{tikzpicture}[scale=.6]
\input{../drawings/per-cpu-loads}
\end{tikzpicture}
\end{column}
\end{columns}
\end{frame}

\begin{frame}{Control algorithm}
\begin{columns}[onlytextwidth]
\begin{column}{0.6\textwidth}
\begin{itemize}
\item Contradicting goals: \begin{itemize}
      \item<2-> System should be responsive
      \item<3-> System should be energy efficient
      \end{itemize}
\item<4-> P-States: \begin{itemize}
      \item<5-> P-States lie
      \item<6-> Extremely low nonsense p-states
      \item<7-> P-State switching has a cost
      \end{itemize}
\end{itemize}
\end{column}
\begin{column}{0.4\textwidth}
\begin{itemize}
\item<8-> Conclusions: \begin{itemize}
      \item<9-> Make the right compromises
      \item<10-> Make it tunable
      \item<11-> Set sane defaults
      \end{itemize}
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\section{How?}

\begin{frame}{Summary}
\begin{columns}[onlytextwidth]
\begin{column}{0.45\textwidth}
\centering
\PDPP
\begin{itemize}
\item<2-> Any granularity p-state changes
\item<4-> Maximum load
\item<6-> Aim for a load target
\item<8-> Filter load to ignore short spikes
\item<10-> Explicit CLA syntax like \lstinline{--max 1.2ghz}
\end{itemize}
\end{column}
\begin{column}{0.1\textwidth}
\centering
versus
\end{column}
\begin{column}{0.45\textwidth}
\centering
powerd
\begin{itemize}
\item<3-> Global p-state changes only
\item<5-> Sum of loads
\item<7-> Hysteresis
\item<9-> Aggressively tuned for responsiveness
\item<11-> Hard coded units \lstinline{-M 1200}
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\begin{frame}{Control algorithm (powerd)}
\centering
\includegraphics[height=6.5cm]{arch_powerd}
\end{frame}

\begin{frame}{Control algorithm (\PDPP)}
\centering
\includegraphics[height=6.5cm]{arch_powerd++}
\end{frame}

\begin{frame}{Dealing with signal noise}
\begin{tikzpicture}
\onslide<1>{\input{../drawings/per-cpu-loads}}
\onslide<2>{\input{../drawings/per-cpu-loads-powerd}}
\onslide<3>{\input{../drawings/per-cpu-loads-powerd-unlimited}}
\onslide<4>{\input{../drawings/per-cpu-loads-filtered}}
\onslide<5>{\input{../drawings/per-cpu-loads-powerd++}}
\end{tikzpicture}
\end{frame}

\section{Conclusions!}

\begin{frame}{Solved problems}
\begin{columns}[onlytextwidth]
\begin{column}{0.5\textwidth}
\begin{itemize}
\item<1-> Load signal noise
\item<3-> Low multi core loads
\end{itemize}
\end{column}
\begin{column}{0.5\textwidth}
\begin{itemize}
\item<2-> Lower sample rate, gliding average
\item<4-> Without breaking single core loads
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\begin{frame}{Unsolved problems}
\begin{columns}[onlytextwidth]
\begin{column}{0.5\textwidth}
\begin{itemize}
\item<1-> High frequency core hopping
\item<3-> P-States that lie reduce accuracy
\item<5-> \lstinline{kern_clock.c} only supports global frequency changes
\end{itemize}
\end{column}
\begin{column}{0.5\textwidth}
\begin{itemize}
\item<2-> This is rare
\item<4-> Ignoring this works well enough
\item<6-> This is fixable, but may break scheduling
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\begin{frame}
\centering
\textbackslash(-)/\\
Praise the sun!\\
\vspace{1cm}
\url{https://github.com/lonkamikaze/powerdxx}
\end{frame}

\end{document}
